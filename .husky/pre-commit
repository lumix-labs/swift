#!/usr/bin/env sh

echo "Running pre-commit hook..."

# Store the root directory
ROOT_DIR=$(git rev-parse --show-toplevel)
EXIT_CODE=0

# Check if committing to master branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
if [ "$CURRENT_BRANCH" = "master" ] || [ "$CURRENT_BRANCH" = "main" ]; then
  echo "❌ Direct commits to master/main branch are not allowed."
  echo "Please create a feature branch and submit a pull request instead."
  exit 1
fi

# Fix known ESLint errors
if [ -f "$ROOT_DIR/.husky/fix-eslint-errors.sh" ]; then
  echo "Applying automated ESLint fixes..."
  chmod +x "$ROOT_DIR/.husky/fix-eslint-errors.sh"
  "$ROOT_DIR/.husky/fix-eslint-errors.sh"
fi

# Run complete validation with local-ci.js
echo "Running comprehensive validation..."
cd "$ROOT_DIR" && npm run ci
VALIDATION_EXIT_CODE=$?
if [ $VALIDATION_EXIT_CODE -ne 0 ]; then
  echo "❌ Validation failed. Please fix the issues before committing."
  EXIT_CODE=$VALIDATION_EXIT_CODE
else
  echo "✅ Validation completed successfully."
fi

# Check if there are any changes in GitHub workflow files
if git diff --cached --name-only | grep -q "\.github/workflows/"; then
  echo "Checking GitHub workflow files..."
  cd "$ROOT_DIR" && node .github/scripts/validate-workflows.js
  WORKFLOW_EXIT_CODE=$?
  if [ $WORKFLOW_EXIT_CODE -ne 0 ]; then
    echo "❌ GitHub workflow validation failed."
    EXIT_CODE=$WORKFLOW_EXIT_CODE
  else
    echo "✅ GitHub workflow validation passed."
  fi
fi

# Check if there are any changes in API files
if git diff --cached --name-only | grep -q "api/"; then
  echo "Checking API files..."
  cd "$ROOT_DIR/api" && npm run lint
  API_EXIT_CODE=$?
  echo "API linting complete with exit code: $API_EXIT_CODE"
  if [ $API_EXIT_CODE -ne 0 ]; then
    EXIT_CODE=$API_EXIT_CODE
  fi
fi

# Check if there are any changes in Web files
if git diff --cached --name-only | grep -q "web/"; then
  echo "Checking Web files..."
  cd "$ROOT_DIR/web" && npm run lint
  WEB_EXIT_CODE=$?
  echo "Web linting complete with exit code: $WEB_EXIT_CODE"
  if [ $WEB_EXIT_CODE -ne 0 ]; then
    EXIT_CODE=$WEB_EXIT_CODE
  fi
fi

# Check if there are any changes in terraform files
if git diff --cached --name-only | grep -q "terraform/"; then
  echo "Checking terraform files..."
  cd "$ROOT_DIR/terraform" && terraform validate
  TERRAFORM_EXIT_CODE=$?
  if [ $TERRAFORM_EXIT_CODE -ne 0 ]; then
    EXIT_CODE=$TERRAFORM_EXIT_CODE
  fi
fi

# Check if there are any changes in MCP-Server files
if git diff --cached --name-only | grep -q "mcp-server/"; then
  echo "Checking MCP-Server files..."
  cd "$ROOT_DIR/mcp-server" && npm run lint
  MCP_EXIT_CODE=$?
  echo "MCP-Server linting complete with exit code: $MCP_EXIT_CODE"
  if [ $MCP_EXIT_CODE -ne 0 ]; then
    EXIT_CODE=$MCP_EXIT_CODE
  fi
fi

# Check if there were any linting errors
if [ $EXIT_CODE -ne 0 ]; then
  echo "❌ Pre-commit hook failed due to linting errors."
  echo "Please fix the linting errors before committing."
  echo "You can run the fix script manually with: $ROOT_DIR/.husky/fix-eslint-errors.sh"
  echo "Or bypass this check with: git commit --no-verify"
  exit $EXIT_CODE
else
  echo "✅ Pre-commit checks completed successfully."
fi

exit $EXIT_CODE